<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Quiz Interactif</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .header {
      background-color: #4CAF50;
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    .quiz-container {
      background-color: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .progress {
      background-color: #e0e0e0;
      border-radius: 10px;
      height: 10px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .progress-bar {
      background-color: #4CAF50;
      height: 100%;
      transition: width 0.3s ease;
    }
    .question-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .theme {
      background-color: #FF9800;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
    }
    .question-text {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 25px;
      color: #333;
      line-height: 1.4;
    }
    .answer-option {
      background-color: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
    }
    .answer-option:hover {
      background-color: #e3f2fd;
      border-color: #2196F3;
    }
    .answer-option.selected {
      background-color: #2196F3;
      color: white;
      border-color: #1976D2;
    }
    .answer-option.queued {
      background-color: #ff9800;
      color: white;
      border-color: #f57c00;
      position: relative;
    }
    .answer-option.queued::after {
      content: '‚è≥ En attente';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      font-weight: bold;
    }
    .previous-answer {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .previous-answer.correct {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    .previous-answer.incorrect {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    .submit-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      transition: background-color 0.3s;
    }
    .submit-btn:hover {
      background-color: #45a049;
    }
    .submit-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .start-btn {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 20px 40px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      display: block;
      margin: 0 auto;
    }
    .results {
      text-align: center;
      padding: 30px;
    }
    .score {
      font-size: 48px;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 20px;
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }
    .status.connected {
      background-color: #d4edda;
      color: #155724;
    }
    .status.disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    .player-stats {
      background-color: #e3f2fd;
      border: 1px solid #2196F3;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-around;
      text-align: center;
    }
    .stat-item {
      flex: 1;
    }
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #2196F3;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .watch-mode {
      background-color: #ff5722;
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }
    .timer {
      background-color: #2196F3;
      color: white;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: bold;
    }
    .timer.warning {
      background-color: #ff9800;
      animation: pulse 1s infinite;
    }
    .timer.danger {
      background-color: #f44336;
      animation: pulse 0.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üéØ Quiz Interactif</h1>
    <p>R√©pondez aux questions une par une</p>
  </div>

  <div id="status" class="status disconnected">Connexion en cours...</div>
  
  <div id="player-stats" class="player-stats" style="display: none;">
    <div class="stat-item">
      <div id="active-players" class="stat-number">0</div>
      <div class="stat-label">Joueurs actifs</div>
    </div>
    <div class="stat-item">
      <div id="watching-players" class="stat-number">0</div>
      <div class="stat-label">En surveillance</div>
    </div>
    <div class="stat-item">
      <div id="total-players" class="stat-number">0</div>
      <div class="stat-label">Total</div>
    </div>
  </div>
  
  <div id="quiz-container" class="quiz-container">
    <div id="start-screen">
      <h2>Pr√™t √† commencer le quiz ?</h2>
      <div style="margin: 20px 0;">
        <label>Th√®me (optionnel):</label><br>
        <input type="text" id="theme-select" placeholder="Ex: Histoire, Science..." style="width: 100%; padding: 8px; margin: 5px 0;">
      </div>
      <div style="margin: 20px 0;">
        <label>Nombre de questions:</label><br>
        <input type="number" id="limit-input" value="10" min="1" max="50" style="width: 100%; padding: 8px; margin: 5px 0;">
      </div>
      <div style="margin: 20px 0;">
        <label>Temps par question (secondes):</label><br>
        <input type="number" id="time-input" value="30" min="5" max="120" style="width: 100%; padding: 8px; margin: 5px 0;">
      </div>
      <button class="start-btn" onclick="startQuiz()">üöÄ Commencer le Quiz</button>
    </div>

    <div id="question-screen" style="display: none;">
      <div class="progress">
        <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
      </div>
      
      <div id="previous-answer" class="previous-answer" style="display: none;">
        <h4>R√©sultat de la question pr√©c√©dente :</h4>
        <p id="previous-question"></p>
        <p id="previous-result"></p>
      </div>

      <div class="question-info">
        <span id="question-theme" class="theme"></span>
        <span id="question-counter"></span>
      </div>

      <div id="question-text" class="question-text"></div>

      <div id="answers-container"></div>

      <button id="submit-btn" class="submit-btn" onclick="submitAnswer()" disabled>
        Mettre en file d'attente
      </button>
      <p style="font-size: 14px; color: #666; text-align: center; margin-top: 10px;">
        Vous pouvez modifier votre r√©ponse jusqu'√† l'expiration du timer
      </p>
    </div>

    <div id="results-screen" style="display: none;">
      <div class="results">
        <h2>üéâ Quiz termin√© !</h2>
        <div id="final-score" class="score"></div>
        <p id="score-message"></p>
        <button class="start-btn" onclick="restartQuiz()">üîÑ Recommencer</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io("http://localhost:3000");
    let currentQuestion = null;
    let selectedAnswer = null;

    // Elements
    const statusElement = document.getElementById('status');
    const startScreen = document.getElementById('start-screen');
    const questionScreen = document.getElementById('question-screen');
    const resultsScreen = document.getElementById('results-screen');
    const progressBar = document.getElementById('progress-bar');
    const previousAnswerDiv = document.getElementById('previous-answer');
    const questionTheme = document.getElementById('question-theme');
    const questionCounter = document.getElementById('question-counter');
    const questionText = document.getElementById('question-text');
    const answersContainer = document.getElementById('answers-container');
    const submitBtn = document.getElementById('submit-btn');
    
    let currentTimeLeft = 0;

    // Socket events
    socket.on("connect", () => {
      statusElement.textContent = `‚úÖ Connect√© au serveur`;
      statusElement.className = 'status connected';
    });

    socket.on("disconnect", () => {
      statusElement.textContent = '‚ùå D√©connect√© - Reconnexion...';
      statusElement.className = 'status disconnected';
    });

    socket.on("quizQuestion", (data) => {
      displayQuestion(data);
    });

    socket.on("quizCompleted", (results) => {
      showResults(results);
    });

    socket.on("timerUpdate", (data) => {
      updateTimer(data.timeLeft, data.hasPendingAnswer);
    });

    socket.on("answerQueued", (data) => {
      showAnswerQueued(data.answer);
    });

    socket.on("playerStats", (stats) => {
      updatePlayerStats(stats);
    });

    socket.on("error", (error) => {
      alert(error.message);
    });

    function startQuiz() {
      const theme = document.getElementById('theme-select')?.value || null;
      const limit = parseInt(document.getElementById('limit-input')?.value) || 10;
      const timeLimit = parseInt(document.getElementById('time-input')?.value) || 30;
      
      socket.emit('startQuiz', { theme, limit, timeLimit });
      startScreen.style.display = 'none';
      questionScreen.style.display = 'block';
    }

    function displayQuestion(data) {
      currentQuestion = data.question;
      selectedAnswer = null;
      currentTimeLeft = data.timeLeft;
      
      // Update player stats if available
      if (data.activePlayers !== undefined) {
        updatePlayerStats({
          activePlayers: data.activePlayers,
          watchingPlayers: data.watchingPlayers,
          totalPlayers: data.totalPlayers
        });
      }
      
      // Show watch mode if active
      let watchModeHtml = '';
      if (data.isWatching) {
        watchModeHtml = '<div class="watch-mode">üîç MODE SURVEILLANCE ACTIV√â - Quiz rejoint en cours !</div>';
      }
      
      // Add timer
      const timerHtml = '<div id="timer" class="timer">‚è±Ô∏è Temps restant: <span id="time-display">' + currentTimeLeft + '</span>s</div>';
      
      // Update progress
      const progress = (data.questionNumber / data.totalQuestions) * 100;
      progressBar.style.width = progress + '%';
      
      // Show previous answer result
      if (data.previousAnswer) {
        previousAnswerDiv.style.display = 'block';
        const prevAnswer = data.previousAnswer;
        previousAnswerDiv.className = `previous-answer ${prevAnswer.correct ? 'correct' : 'incorrect'}`;
        document.getElementById('previous-question').textContent = 'Question pr√©c√©dente';
        const answerText = prevAnswer.userAnswer === 0 ? 'Temps expir√©' : prevAnswer.userAnswer;
        document.getElementById('previous-result').innerHTML = 
          `Votre r√©ponse: ${answerText} | ${prevAnswer.correct ? '‚úÖ Correct !' : '‚ùå Incorrect'}`;
      } else {
        previousAnswerDiv.style.display = 'none';
      }
      
      // Update question info
      questionTheme.textContent = currentQuestion.theme;
      questionCounter.textContent = `Question ${data.questionNumber}/${data.totalQuestions}`;
      questionText.textContent = currentQuestion.questionText;
      
      // Create answer options with watch mode and timer
      answersContainer.innerHTML = watchModeHtml + timerHtml;
      for (let i = 1; i <= 4; i++) {
        const option = document.createElement('div');
        option.className = 'answer-option';
        option.textContent = `${i}. ${currentQuestion[`response${i}`]}`;
        if (!data.isWatching) {
          option.onclick = () => selectAnswer(i, option);
        } else {
          option.style.cursor = 'not-allowed';
          option.style.opacity = '0.6';
        }
        answersContainer.appendChild(option);
      }
      
      submitBtn.disabled = data.isWatching || true;
      if (data.isWatching) {
        submitBtn.textContent = 'Mode surveillance - Lecture seule';
        submitBtn.style.backgroundColor = '#cccccc';
      }
    }
    
    function updateTimer(timeLeft, hasPendingAnswer) {
      currentTimeLeft = timeLeft;
      const timerElement = document.getElementById('timer');
      const timeDisplay = document.getElementById('time-display');
      
      if (timeDisplay) {
        let timerText = timeLeft;
        if (hasPendingAnswer) {
          timerText += ' (r√©ponse en attente)';
        }
        timeDisplay.textContent = timerText;
        
        if (timeLeft <= 5) {
          timerElement.className = 'timer danger';
        } else if (timeLeft <= 10) {
          timerElement.className = 'timer warning';
        } else {
          timerElement.className = 'timer';
        }
      }
    }
    
    function showAnswerQueued(answer) {
      // Marquer visuellement la r√©ponse s√©lectionn√©e comme "en attente"
      document.querySelectorAll('.answer-option').forEach((opt, index) => {
        opt.classList.remove('selected', 'queued');
        if (index + 1 === answer) {
          opt.classList.add('queued');
        }
      });
    }

    function selectAnswer(answerNum, element) {
      // Remove previous selection
      document.querySelectorAll('.answer-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      // Select current answer
      element.classList.add('selected');
      selectedAnswer = answerNum;
      submitBtn.disabled = false;
    }

    function submitAnswer() {
      if (selectedAnswer && currentQuestion) {
        socket.emit('submitAnswer', {
          questionId: currentQuestion.id,
          answer: selectedAnswer
        });
        submitBtn.disabled = true;
      }
    }

    function showResults(results) {
      questionScreen.style.display = 'none';
      resultsScreen.style.display = 'block';
      
      const percentage = Math.round((results.score / results.totalQuestions) * 100);
      document.getElementById('final-score').textContent = `${results.score}/${results.totalQuestions}`;
      
      let message = '';
      if (percentage >= 80) message = 'üèÜ Excellent ! Vous ma√Ætrisez le sujet !';
      else if (percentage >= 60) message = 'üëç Bien jou√© ! Continuez comme √ßa !';
      else if (percentage >= 40) message = 'üìö Pas mal, mais vous pouvez mieux faire !';
      else message = 'üí™ Il faut r√©viser, mais ne vous d√©couragez pas !';
      
      document.getElementById('score-message').textContent = message;
    }

    function updatePlayerStats(stats) {
      document.getElementById('player-stats').style.display = 'flex';
      document.getElementById('active-players').textContent = stats.activePlayers;
      document.getElementById('watching-players').textContent = stats.watchingPlayers;
      document.getElementById('total-players').textContent = stats.totalPlayers;
    }

    function restartQuiz() {
      resultsScreen.style.display = 'none';
      startScreen.style.display = 'block';
      progressBar.style.width = '0%';
      document.getElementById('player-stats').style.display = 'none';
    }
  </script>
</body>
</html>
