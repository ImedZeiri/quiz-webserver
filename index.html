<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Quiz Interactif</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .header {
      background-color: #4CAF50;
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    .quiz-container {
      background-color: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .progress {
      background-color: #e0e0e0;
      border-radius: 10px;
      height: 10px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .progress-bar {
      background-color: #4CAF50;
      height: 100%;
      transition: width 0.3s ease;
    }
    .question-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .theme {
      background-color: #FF9800;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
    }
    .question-text {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 25px;
      color: #333;
      line-height: 1.4;
    }
    .answer-option {
      background-color: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
    }
    .answer-option:hover {
      background-color: #e3f2fd;
      border-color: #2196F3;
    }
    .answer-option.selected {
      background-color: #2196F3;
      color: white;
      border-color: #1976D2;
    }
    .answer-option.queued {
      background-color: #ff9800;
      color: white;
      border-color: #f57c00;
      position: relative;
    }
    .answer-option.queued::after {
      content: '‚è≥ En attente';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      font-weight: bold;
    }
    .previous-answer {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .previous-answer.correct {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    .previous-answer.incorrect {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    .submit-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      transition: background-color 0.3s;
    }
    .submit-btn:hover {
      background-color: #45a049;
    }
    .submit-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .start-btn {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 20px 40px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      display: block;
      margin: 0 auto;
    }
    .results {
      text-align: center;
      padding: 30px;
    }
    .score {
      font-size: 48px;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 20px;
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }
    .status.connected {
      background-color: #d4edda;
      color: #155724;
    }
    .status.disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    .player-stats {
      background-color: #e3f2fd;
      border: 1px solid #2196F3;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-around;
      text-align: center;
    }
    .stat-item {
      flex: 1;
    }
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #2196F3;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .watch-mode {
      background-color: #ff5722;
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }
    .timer {
      background-color: #2196F3;
      color: white;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: bold;
    }
    .timer.warning {
      background-color: #ff9800;
      animation: pulse 1s infinite;
    }
    .timer.danger {
      background-color: #f44336;
      animation: pulse 0.5s infinite;
    }
    .next-event {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
    }
    .lobby-section {
      background: linear-gradient(45deg, #f093fb, #f5576c);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
    }
    .countdown {
      font-size: 24px;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
    }
    .event-banner {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      animation: eventPulse 3s infinite;
    }
    .winner-announcement {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #333;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      margin: 20px 0;
      font-weight: bold;
      box-shadow: 0 8px 16px rgba(255, 215, 0, 0.3);
      animation: winnerGlow 2s infinite;
    }
    .winner-crown {
      font-size: 48px;
      margin-bottom: 10px;
      animation: bounce 1s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    @keyframes eventPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    @keyframes winnerGlow {
      0%, 100% { box-shadow: 0 8px 16px rgba(255, 215, 0, 0.3); }
      50% { box-shadow: 0 12px 24px rgba(255, 215, 0, 0.6); }
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üéØ Quiz Interactif</h1>
    <p>R√©pondez aux questions une par une</p>
  </div>

  <div id="status" class="status disconnected">Connexion en cours...</div>
  
  <div id="next-event" class="next-event" style="display: none;">
    <h3>üìÖ Prochain √âv√©nement</h3>
    <div id="next-event-details"></div>
    <div id="event-countdown" class="countdown"></div>
  </div>
  
  <div id="lobby-section" class="lobby-section" style="display: none;">
    <h3>üö™ Lobby Ouvert</h3>
    <div id="lobby-details"></div>
    <div id="lobby-countdown" class="countdown"></div>
    <div id="lobby-participants"></div>
    <button id="join-lobby-btn" class="start-btn" onclick="joinLobby()">Rejoindre le Lobby</button>
  </div>
  
  <div id="event-banner" class="event-banner" style="display: none;">
    <div>üéâ √âV√âNEMENT EN COURS üéâ</div>
    <div id="event-details"></div>
  </div>
  
  <div id="player-stats" class="player-stats" style="display: none;">
    <div class="stat-item">
      <div id="active-players" class="stat-number">0</div>
      <div class="stat-label">Joueurs actifs</div>
    </div>
    <div class="stat-item">
      <div id="watching-players" class="stat-number">0</div>
      <div class="stat-label">En surveillance</div>
    </div>
    <div class="stat-item">
      <div id="total-players" class="stat-number">0</div>
      <div class="stat-label">Total</div>
    </div>
  </div>
  
  <div id="quiz-container" class="quiz-container">
    <div id="start-screen">
      <h2>Pr√™t √† commencer le quiz ?</h2>
      <div style="margin: 20px 0;">
        <label>Th√®me (optionnel):</label><br>
        <input type="text" id="theme-select" placeholder="Ex: Histoire, Science..." style="width: 100%; padding: 8px; margin: 5px 0;">
      </div>
      <div style="margin: 20px 0;">
        <label>Nombre de questions:</label><br>
        <input type="number" id="limit-input" value="10" min="1" max="50" style="width: 100%; padding: 8px; margin: 5px 0;">
      </div>
      <div style="margin: 20px 0;">
        <label>Temps par question (secondes):</label><br>
        <input type="number" id="time-input" value="30" min="5" max="120" style="width: 100%; padding: 8px; margin: 5px 0;">
      </div>
      <button class="start-btn" onclick="startQuiz()">üöÄ Commencer le Quiz</button>
    </div>

    <div id="question-screen" style="display: none;">
      <div class="progress">
        <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
      </div>
      
      <div id="previous-answer" class="previous-answer" style="display: none;">
        <h4>R√©sultat de la question pr√©c√©dente :</h4>
        <p id="previous-question"></p>
        <p id="previous-result"></p>
      </div>

      <div class="question-info">
        <span id="question-theme" class="theme"></span>
        <span id="question-counter"></span>
      </div>

      <div id="question-text" class="question-text"></div>

      <div id="answers-container"></div>

      <button id="submit-btn" class="submit-btn" onclick="submitAnswer()" disabled>
        Mettre en file d'attente
      </button>
      <p style="font-size: 14px; color: #666; text-align: center; margin-top: 10px;">
        Vous pouvez modifier votre r√©ponse jusqu'√† l'expiration du timer
      </p>
    </div>

    <div id="results-screen" style="display: none;">
      <div class="results">
        <h2>üéâ Quiz termin√© !</h2>
        <div id="winner-announcement" class="winner-announcement" style="display: none;">
          <div class="winner-crown">üëë</div>
          <div id="winner-message"></div>
        </div>
        <div id="final-score" class="score"></div>
        <p id="score-message"></p>
        <button class="start-btn" onclick="restartQuiz()">üîÑ Recommencer</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io("http://localhost:3000");
    let currentQuestion = null;
    let selectedAnswer = null;

    // Elements
    const statusElement = document.getElementById('status');
    const startScreen = document.getElementById('start-screen');
    const questionScreen = document.getElementById('question-screen');
    const resultsScreen = document.getElementById('results-screen');
    const progressBar = document.getElementById('progress-bar');
    const previousAnswerDiv = document.getElementById('previous-answer');
    const questionTheme = document.getElementById('question-theme');
    const questionCounter = document.getElementById('question-counter');
    const questionText = document.getElementById('question-text');
    const answersContainer = document.getElementById('answers-container');
    const submitBtn = document.getElementById('submit-btn');
    
    let currentTimeLeft = 0;

    // Socket events
    socket.on("connect", () => {
      statusElement.textContent = `‚úÖ Connect√© au serveur`;
      statusElement.className = 'status connected';
    });

    socket.on("disconnect", () => {
      statusElement.textContent = '‚ùå D√©connect√© - Reconnexion...';
      statusElement.className = 'status disconnected';
    });

    socket.on("quizQuestion", (data) => {
      displayQuestion(data);
    });

    socket.on("quizCompleted", (results) => {
      showResults(results);
    });

    socket.on("timerUpdate", (data) => {
      updateTimer(data.timeLeft, data.hasPendingAnswer);
    });

    socket.on("answerQueued", (data) => {
      showAnswerQueued(data.answer);
    });

    socket.on("playerStats", (stats) => {
      updatePlayerStats(stats);
    });

    socket.on("error", (error) => {
      alert(error.message);
    });

    socket.on("eventStarted", (data) => {
      showEventBanner(data.event);
    });

    socket.on("eventCompleted", (data) => {
      hideEventBanner();
    });

    socket.on("nextEvent", (event) => {
      showNextEvent(event);
    });

    socket.on("lobbyOpened", (data) => {
      showLobby(data.event);
    });

    socket.on("eventCountdown", (data) => {
      updateEventCountdown(data.timeLeft, data.participants, data.minPlayers);
    });

    socket.on("lobbyJoined", (data) => {
      showLobbyJoined(data);
    });

    socket.on("lobbyUpdate", (data) => {
      updateLobbyParticipants(data.participants, data.minPlayers);
    });

    socket.on("eventCancelled", (data) => {
      showEventCancelled(data);
    });

    socket.on("autoStartQuiz", (data) => {
      // D√©marrer automatiquement le quiz pour les participants du lobby
      document.getElementById('lobby-section').style.display = 'none';
      startScreen.style.display = 'none';
      questionScreen.style.display = 'block';
    });

    function startQuiz() {
      const theme = document.getElementById('theme-select')?.value || null;
      const limit = parseInt(document.getElementById('limit-input')?.value) || 10;
      const timeLimit = parseInt(document.getElementById('time-input')?.value) || 30;
      
      socket.emit('startQuiz', { theme, limit, timeLimit });
      startScreen.style.display = 'none';
      questionScreen.style.display = 'block';
    }

    function displayQuestion(data) {
      currentQuestion = data.question;
      selectedAnswer = null;
      currentTimeLeft = data.timeLeft;
      
      // Update player stats if available
      if (data.activePlayers !== undefined) {
        updatePlayerStats({
          activePlayers: data.activePlayers,
          watchingPlayers: data.watchingPlayers,
          totalPlayers: data.totalPlayers
        });
      }
      
      // Show watch mode if active
      let watchModeHtml = '';
      if (data.isWatching) {
        watchModeHtml = '<div class="watch-mode">üîç MODE SURVEILLANCE ACTIV√â - Quiz rejoint en cours !</div>';
      }
      
      // Add timer
      const timerHtml = '<div id="timer" class="timer">‚è±Ô∏è Temps restant: <span id="time-display">' + currentTimeLeft + '</span>s</div>';
      
      // Update progress
      const progress = (data.questionNumber / data.totalQuestions) * 100;
      progressBar.style.width = progress + '%';
      
      // Show previous answer result
      if (data.previousAnswer) {
        previousAnswerDiv.style.display = 'block';
        const prevAnswer = data.previousAnswer;
        previousAnswerDiv.className = `previous-answer ${prevAnswer.correct ? 'correct' : 'incorrect'}`;
        document.getElementById('previous-question').textContent = 'Question pr√©c√©dente';
        const answerText = prevAnswer.userAnswer === 0 ? 'Temps expir√©' : prevAnswer.userAnswer;
        document.getElementById('previous-result').innerHTML = 
          `Votre r√©ponse: ${answerText} | ${prevAnswer.correct ? '‚úÖ Correct !' : '‚ùå Incorrect'}`;
      } else {
        previousAnswerDiv.style.display = 'none';
      }
      
      // Update question info
      questionTheme.textContent = currentQuestion.theme;
      questionCounter.textContent = `Question ${data.questionNumber}/${data.totalQuestions}`;
      questionText.textContent = currentQuestion.questionText;
      
      // Create answer options with watch mode and timer
      answersContainer.innerHTML = watchModeHtml + timerHtml;
      for (let i = 1; i <= 4; i++) {
        const option = document.createElement('div');
        option.className = 'answer-option';
        option.textContent = `${i}. ${currentQuestion[`response${i}`]}`;
        if (!data.isWatching) {
          option.onclick = () => selectAnswer(i, option);
        } else {
          option.style.cursor = 'not-allowed';
          option.style.opacity = '0.6';
        }
        answersContainer.appendChild(option);
      }
      
      submitBtn.disabled = data.isWatching || true;
      if (data.isWatching) {
        submitBtn.textContent = 'Mode surveillance - Lecture seule';
        submitBtn.style.backgroundColor = '#cccccc';
      }
    }
    
    function updateTimer(timeLeft, hasPendingAnswer) {
      currentTimeLeft = timeLeft;
      const timerElement = document.getElementById('timer');
      const timeDisplay = document.getElementById('time-display');
      
      if (timeDisplay) {
        let timerText = timeLeft;
        if (hasPendingAnswer) {
          timerText += ' (r√©ponse en attente)';
        }
        timeDisplay.textContent = timerText;
        
        if (timeLeft <= 5) {
          timerElement.className = 'timer danger';
        } else if (timeLeft <= 10) {
          timerElement.className = 'timer warning';
        } else {
          timerElement.className = 'timer';
        }
      }
    }
    
    function showAnswerQueued(answer) {
      // Marquer visuellement la r√©ponse s√©lectionn√©e comme "en attente"
      document.querySelectorAll('.answer-option').forEach((opt, index) => {
        opt.classList.remove('selected', 'queued');
        if (index + 1 === answer) {
          opt.classList.add('queued');
        }
      });
    }

    function selectAnswer(answerNum, element) {
      // Remove previous selection
      document.querySelectorAll('.answer-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      // Select current answer
      element.classList.add('selected');
      selectedAnswer = answerNum;
      submitBtn.disabled = false;
    }

    function submitAnswer() {
      if (selectedAnswer && currentQuestion) {
        socket.emit('submitAnswer', {
          questionId: currentQuestion.id,
          answer: selectedAnswer
        });
        submitBtn.disabled = true;
      }
    }

    function showResults(results) {
      questionScreen.style.display = 'none';
      resultsScreen.style.display = 'block';
      
      // Afficher l'annonce du gagnant si applicable
      const winnerAnnouncement = document.getElementById('winner-announcement');
      const winnerMessage = document.getElementById('winner-message');
      
      if (results.winner) {
        winnerAnnouncement.style.display = 'block';
        if (results.isWinner) {
          winnerMessage.innerHTML = 'üéä F√âLICITATIONS ! üéä<br>Vous √™tes le GAGNANT de cet √©v√©nement !';
        } else {
          winnerMessage.innerHTML = `üèÜ Gagnant de l'√©v√©nement : Joueur ${results.winner.substring(0, 8)}...`;
        }
      } else {
        winnerAnnouncement.style.display = 'none';
      }
      
      const percentage = Math.round((results.score / results.totalQuestions) * 100);
      document.getElementById('final-score').textContent = `${results.score}/${results.totalQuestions}`;
      
      let message = '';
      if (results.joinedAt > 0) {
        message = `üì∫ Mode surveillance - Rejoint √† la question ${results.joinedAt + 1}`;
      } else if (percentage >= 80) {
        message = 'üèÜ Excellent ! Vous ma√Ætrisez le sujet !';
      } else if (percentage >= 60) {
        message = 'üëç Bien jou√© ! Continuez comme √ßa !';
      } else if (percentage >= 40) {
        message = 'üìö Pas mal, mais vous pouvez mieux faire !';
      } else {
        message = 'üí™ Il faut r√©viser, mais ne vous d√©couragez pas !';
      }
      
      document.getElementById('score-message').textContent = message;
    }

    function updatePlayerStats(stats) {
      document.getElementById('player-stats').style.display = 'flex';
      document.getElementById('active-players').textContent = stats.activePlayers;
      document.getElementById('watching-players').textContent = stats.watchingPlayers;
      document.getElementById('total-players').textContent = stats.totalPlayers;
    }

    function showEventBanner(event) {
      const banner = document.getElementById('event-banner');
      const details = document.getElementById('event-details');
      
      banner.style.display = 'block';
      details.innerHTML = `
        <div>Th√®me: ${event.theme}</div>
        <div>${event.numberOfQuestions} questions ‚Ä¢ Soyez le premier √† tout r√©ussir pour gagner !</div>
      `;
    }

    function hideEventBanner() {
      document.getElementById('event-banner').style.display = 'none';
    }

    function restartQuiz() {
      resultsScreen.style.display = 'none';
      startScreen.style.display = 'block';
      progressBar.style.width = '0%';
      document.getElementById('player-stats').style.display = 'none';
      document.getElementById('winner-announcement').style.display = 'none';
    }

    function showNextEvent(event) {
      const nextEventDiv = document.getElementById('next-event');
      const detailsDiv = document.getElementById('next-event-details');
      
      nextEventDiv.style.display = 'block';
      detailsDiv.innerHTML = `
        <div><strong>Th√®me:</strong> ${event.theme}</div>
        <div><strong>Questions:</strong> ${event.numberOfQuestions}</div>
        <div><strong>D√©but:</strong> ${new Date(event.startDate).toLocaleString('fr-FR')}</div>
      `;
      
      startEventCountdown(event.startDate);
    }

    function startEventCountdown(startDate) {
      const countdownDiv = document.getElementById('event-countdown');
      
      const updateCountdown = () => {
        const now = new Date().getTime();
        const eventTime = new Date(startDate).getTime();
        const timeLeft = Math.max(0, Math.floor((eventTime - now) / 1000));
        
        if (timeLeft > 0) {
          const hours = Math.floor(timeLeft / 3600);
          const minutes = Math.floor((timeLeft % 3600) / 60);
          const seconds = timeLeft % 60;
          
          countdownDiv.innerHTML = `‚è∞ D√©but dans: ${hours}h ${minutes}m ${seconds}s`;
        } else {
          countdownDiv.innerHTML = 'üöÄ √âv√©nement en cours!';
        }
      };
      
      updateCountdown();
      setInterval(updateCountdown, 1000);
    }

    function showLobby(event) {
      document.getElementById('next-event').style.display = 'none';
      const lobbyDiv = document.getElementById('lobby-section');
      const detailsDiv = document.getElementById('lobby-details');
      
      lobbyDiv.style.display = 'block';
      detailsDiv.innerHTML = `
        <div><strong>√âv√©nement:</strong> ${event.theme}</div>
        <div><strong>Questions:</strong> ${event.numberOfQuestions}</div>
        <div><strong>Joueurs requis:</strong> ${event.minPlayers}</div>
      `;
    }

    function updateEventCountdown(timeLeft, participants, minPlayers) {
      const countdownDiv = document.getElementById('lobby-countdown');
      const participantsDiv = document.getElementById('lobby-participants');
      
      if (timeLeft > 0) {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        countdownDiv.innerHTML = `‚è∞ D√©but dans: ${minutes}m ${seconds}s`;
      } else {
        countdownDiv.innerHTML = 'üöÄ Lancement!';
      }
      
      participantsDiv.innerHTML = `üë• Joueurs: ${participants}/${minPlayers}`;
    }

    function joinLobby() {
      socket.emit('joinLobby');
    }

    function showLobbyJoined(data) {
      const joinBtn = document.getElementById('join-lobby-btn');
      joinBtn.textContent = '‚úÖ Dans le lobby';
      joinBtn.disabled = true;
      joinBtn.style.backgroundColor = '#4CAF50';
    }

    function updateLobbyParticipants(participants, minPlayers) {
      const participantsDiv = document.getElementById('lobby-participants');
      participantsDiv.innerHTML = `üë• Joueurs: ${participants}/${minPlayers}`;
    }


    function autoStartQuiz(data) {
      // Masquer le lobby et d√©marrer le quiz automatiquement
      document.getElementById('lobby-section').style.display = 'none';
      startScreen.style.display = 'none';
      questionScreen.style.display = 'block';
    }
  </script>
</body>
</html>
